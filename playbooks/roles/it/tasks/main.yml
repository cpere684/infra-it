---
# Role: it - prepare developer / IT workstation on Ubuntu
# Patched to:
# - normalize existing apt source Signed-By paths for Docker and Microsoft repos
# - normalize Microsoft repo Signed-By aggressively to avoid conflicts
# - avoid tasks that fail in check mode (downloads, service start, adding keys)
# - use stat+get_url pattern for idempotent downloads

# ---------- Preflight: normalize Docker apt source Signed-By paths ----------
- name: Stat legacy docker keyring at /etc/apt/keyrings/docker.gpg
  stat:
    path: /etc/apt/keyrings/docker.gpg
  register: docker_keyring_etc
  changed_when: false

- name: Stat alternate docker keyring at /usr/share/keyrings/docker-archive-keyring.gpg
  stat:
    path: /usr/share/keyrings/docker-archive-keyring.gpg
  register: docker_keyring_usr
  changed_when: false

- name: Find existing apt source files that mention download.docker.com
  shell: "grep -l 'download.docker.com/linux/ubuntu' /etc/apt/sources.list.d/* 2>/dev/null || true"
  register: docker_sources
  changed_when: false

- name: Normalize docker sources to use /etc/apt/keyrings/docker.gpg if present
  replace:
    path: "{{ item }}"
    regexp: "/usr/share/keyrings/docker-archive-keyring.gpg"
    replace: "/etc/apt/keyrings/docker.gpg"
  loop: "{{ docker_sources.stdout_lines | default([]) }}"
  when:
    - docker_keyring_etc.stat.exists
    - docker_sources.stdout != ""

- name: Normalize docker sources to use /usr/share/keyrings/docker-archive-keyring.gpg if etc keyring absent
  replace:
    path: "{{ item }}"
    regexp: "/etc/apt/keyrings/docker.gpg"
    replace: "/usr/share/keyrings/docker-archive-keyring.gpg"
  loop: "{{ docker_sources.stdout_lines | default([]) }}"
  when:
    - not docker_keyring_etc.stat.exists
    - docker_keyring_usr.stat.exists
    - docker_sources.stdout != ""

# ---------- Preflight: normalize Microsoft apt source Signed-By paths (aggressive) ----------
- name: Find existing apt source files that mention packages.microsoft.com
  shell: "grep -l 'packages.microsoft.com/repos/code' /etc/apt/sources.list.d/* 2>/dev/null || true"
  register: microsoft_sources
  changed_when: false

- name: Replace any microsoft key path occurrences with canonical key path in Microsoft repo files
  replace:
    path: "{{ item }}"
    regexp: '(/usr/share/keyrings/microsoft\\.gpg|/etc/apt/keyrings/microsoft\\.gpg|/usr/share/keyrings/microsoft-archive-keyring\\.gpg)'
    replace: '/usr/share/keyrings/microsoft-archive-keyring.gpg'
  loop: "{{ microsoft_sources.stdout_lines | default([]) }}"
  when: microsoft_sources.stdout != ""

# ---------- Main tasks ----------
- name: Ensure apt cache is up-to-date
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install base packages required for later steps
  apt:
    name: "{{ it_extra_packages | default([]) }}"
    state: present

# ---------- Docker installation (idempotent) ----------
- name: Check for existing docker keyring at /etc/apt/keyrings/docker.gpg
  stat:
    path: /etc/apt/keyrings/docker.gpg
  register: existing_docker_keyring

- name: Set docker_keyring_path (reuse existing keyring if present)
  set_fact:
    docker_keyring_path: "{{ '/etc/apt/keyrings/docker.gpg' if existing_docker_keyring.stat.exists else '/usr/share/keyrings/docker-archive-keyring.gpg' }}"

- name: Ensure keyring parent directory exists when using /etc/apt/keyrings
  file:
    path: "{{ docker_keyring_path | dirname }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  when: docker_keyring_path is match('^/etc/apt/keyrings')

- name: Add Docker GPG keyring (curl -> gpg -> chosen keyring path)
  shell: |
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o {{ docker_keyring_path }}
  args:
    creates: "{{ docker_keyring_path }}"
  become: true

- name: Add Docker apt repository (signed-by selected keyring)
  apt_repository:
    repo: "deb [arch=amd64 signed-by={{ docker_keyring_path }}] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable"
    filename: docker
    state: present
  notify: apt update

- name: Install docker packages
  apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
    state: latest
    update_cache: yes
  ignore_errors: yes

- name: Ensure docker service is enabled and running
  service:
    name: docker
    enabled: yes
    state: started
  when: not ansible_check_mode
  ignore_errors: yes

- name: Install docker-compose plugin directory
  file:
    path: /usr/local/lib/docker/cli-plugins
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Check if docker compose plugin exists
  stat:
    path: /usr/local/lib/docker/cli-plugins/docker-compose
  register: docker_compose_plugin

- name: Download docker compose plugin (v2) if missing
  get_url:
    url: "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-linux-x86_64"
    dest: /usr/local/lib/docker/cli-plugins/docker-compose
    mode: '0755'
    force: no
  when:
    - not docker_compose_plugin.stat.exists
    - not ansible_check_mode
  ignore_errors: yes

# ---------- VS Code (Microsoft repo) ----------
- name: Ensure directory for microsoft keyrings exists
  file:
    path: /usr/share/keyrings
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Add Microsoft GPG keyring for VS Code
  shell: |
    curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /usr/share/keyrings/microsoft-archive-keyring.gpg
  args:
    creates: /usr/share/keyrings/microsoft-archive-keyring.gpg
  become: true

- name: Add VS Code repository
  apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft-archive-keyring.gpg] https://packages.microsoft.com/repos/code stable main"
    filename: microsoft-vscode
    state: present
  notify: apt update

- name: Install code (Visual Studio Code) on amd64 only
  apt:
    name: code
    state: latest
  when: ansible_architecture in ['x86_64', 'amd64']
  ignore_errors: yes

# ---------- Create IT user ----------
- name: Ensure it user exists
  user:
    name: "{{ it_user }}"
    state: present
    groups: sudo
    shell: /bin/bash
    create_home: yes

- name: Ensure typical user directories exist for IT user
  file:
    path: "/home/{{ it_user }}/{{ item }}"
    state: directory
    owner: "{{ it_user }}"
    group: "{{ it_user }}"
    mode: '0755'
  loop:
    - Documents
    - Desktop
    - Projects
    - .ssh

- name: Add ssh public key for it user (skip in check mode)
  authorized_key:
    user: "{{ it_user }}"
    key: "{{ ssh_pub_key }}"
    state: present
  when: not ansible_check_mode

# ---------- Security tools ----------
- name: Install security and utility packages
  apt:
    name:
      - ufw
      - fail2ban
      - unattended-upgrades
    state: present

- name: Configure UFW default policies (enable only on Debian-family)
  ufw:
    state: enabled
    policy: deny
    logging: 'on'
  when: ansible_os_family == "Debian"
  ignore_errors: yes

- name: Allow SSH through UFW
  ufw:
    rule: allow
    name: OpenSSH
  when: not ansible_check_mode
  ignore_errors: yes

- name: Allow Docker ports (common) via UFW (non-exhaustive)
  ufw:
    rule: allow
    port: 2376
    proto: tcp
  when: not ansible_check_mode
  ignore_errors: yes

- name: Ensure fail2ban is enabled and started
  service:
    name: fail2ban
    state: started
    enabled: yes
  when: not ansible_check_mode

# ---------- SSH hardening (safe defaults) ----------
- name: Harden SSH server configuration (disable root login and password auth)
  blockinfile:
    path: /etc/ssh/sshd_config
    marker: "# {mark} ANSIBLE-IT-HARDEN"
    block: |
      PasswordAuthentication no
      PermitRootLogin no
      ChallengeResponseAuthentication no
  notify: restart ssh
  when: not ansible_check_mode

# ---------- Optional networking (apply only when provided) ----------
- name: Deploy netplan config if netplan_config provided
  copy:
    dest: /etc/netplan/01-custom.yaml
    content: "{{ netplan_config }}"
    owner: root
    group: root
    mode: '0644'
  when:
    - netplan_config | length > 0
    - not ansible_check_mode
  notify: apply netplan

# ---------- Add it_user to docker group ----------
- name: Add it_user to docker group
  user:
    name: "{{ it_user }}"
    groups: docker
    append: yes
  ignore_errors: yes

# Ensure home ownership and perms are correct (skip in check mode)
- name: Ensure home ownership and perms are correct
  file:
    path: "/home/{{ it_user }}"
    state: directory
    owner: "{{ it_user }}"
    group: "{{ it_user }}"
    recurse: yes
  when: not ansible_check_mode
  ignore_errors: yes

# ---------- Cleanup ----------
- name: Run apt autoremove/autoclean
  apt:
    autoremove: yes
    autoclean: yes
  tags: cleanup
